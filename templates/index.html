<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Add to existing style.css */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e93c4 0%, #2aabee 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading overlay (will be hidden after check) -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="telegram-logo">
            <i class="fab fa-telegram-plane"></i>
        </div>
        
        <div class="login-card">
            <div class="card-header">
                <h1><i class="fab fa-telegram-plane"></i> Telegram Verification</h1>
                <p class="subtitle">Get code from bot and enter below</p>
            </div>
            
            <div class="card-body">
                <div class="instruction">
                    <div class="instruction-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <p>
                        1. Click the button below to get code from bot<br>
                        2. Enter the 4-digit code below
                    </p>
                </div>
                
                <!-- Bot Link Button -->
                <div class="bot-link-container">
                    <a href="{{ bot_link }}" target="_blank" class="btn-bot">
                        <i class="fab fa-telegram-plane"></i> Get Code from Telegram Bot
                    </a>
                </div>
                
                <!-- Code Input -->
                <div class="code-input-container">
                    <div class="code-input-wrapper">
                        <input type="text" id="code1" maxlength="1" class="code-input" data-index="0">
                        <input type="text" id="code2" maxlength="1" class="code-input" data-index="1">
                        <input type="text" id="code3" maxlength="1" class="code-input" data-index="2">
                        <input type="text" id="code4" maxlength="1" class="code-input" data-index="3">
                    </div>
                    <input type="hidden" id="session-id" value="{{ session_id }}">
                    
                    <div class="timer-container">
                        <i class="fas fa-clock"></i>
                        <span id="timer">05:00</span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="actions">
                    <button class="btn-verify" onclick="verify()">
                        <i class="fas fa-shield-check"></i> Verify Code
                    </button>
                    <button class="btn-resend" onclick="resendCode()" disabled>
                        <i class="fas fa-redo"></i> Get New Code
                    </button>
                </div>
                
                <!-- Status Message -->
                <div class="status-message" id="status"></div>
                
                <!-- Info Box -->
                <div class="telegram-info">
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <p>Make sure you're entering the code from the official Telegram bot. Never share this code with anyone.</p>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <p><i class="fas fa-lock"></i> Secured by Telegram's encryption</p>
                <p class="help-link"><a href="#"><i class="fas fa-question-circle"></i> Need help?</a></p>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2026 Telegram Messenger. This is a demonstration page.</p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Check if user is already verified on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/session-check');
                const data = await response.json();
                
                if (data.valid) {
                    // User is already verified, redirect to dashboard
                    window.location.href = '/dashboard';
                    return;
                }
                
                // User not verified, show login page
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                // Initialize code input functionality
                initializeCodeInput();
                startTimer();
                
            } catch (error) {
                console.error('Error checking session:', error);
                // Show page anyway on error
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                initializeCodeInput();
                startTimer();
            }
        });

        function initializeCodeInput() {
            const inputs = document.querySelectorAll('.code-input');
            
            if (inputs.length > 0) {
                inputs[0].focus();
                
                inputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        this.value = this.value.replace(/\D/g, '');
                        
                        if (this.value.length === 1) {
                            const nextIndex = parseInt(this.dataset.index) + 1;
                            if (nextIndex < inputs.length) {
                                inputs[nextIndex].focus();
                            }
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value.length === 0) {
                            const prevIndex = parseInt(this.dataset.index) - 1;
                            if (prevIndex >= 0) {
                                inputs[prevIndex].focus();
                            }
                        }
                        
                        if (e.key === 'ArrowLeft') {
                            const prevIndex = parseInt(this.dataset.index) - 1;
                            if (prevIndex >= 0) {
                                inputs[prevIndex].focus();
                            }
                        }
                        
                        if (e.key === 'ArrowRight') {
                            const nextIndex = parseInt(this.dataset.index) + 1;
                            if (nextIndex < inputs.length) {
                                inputs[nextIndex].focus();
                            }
                        }
                        
                        if (e.key === 'Enter') {
                            verify();
                        }
                    });
                    
                    input.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pasteData = e.clipboardData.getData('text').replace(/\D/g, '');
                        
                        for (let i = 0; i < Math.min(pasteData.length, inputs.length); i++) {
                            inputs[i].value = pasteData[i];
                        }
                        
                        const nextEmptyIndex = Array.from(inputs).findIndex(input => input.value === '');
                        if (nextEmptyIndex !== -1) {
                            inputs[nextEmptyIndex].focus();
                        } else {
                            inputs[inputs.length - 1].focus();
                        }
                    });
                });
            }
        }
    </script>
</body>
</html>